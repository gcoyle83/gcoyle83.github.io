---
layout: post
title:  "Replication notes - `swmm_mpc`"
---

## Introduction
In this post I'll be reviewing the main steps taken to reproduce using SWMM for model predictive control as demonstrated in the paper [Leveraging Open Source Software and Parallel Computing for
Model Predictive Control of Urban Drainage Systems using
EPA-SWMM5](https://uvahydroinformatics.org/files/Sadler_EMS_2019_Preprint.pdf) (Sadler, et al., 2019).

Other required resources:
-  [Github repo](https://github.com/UVAdMIST/swmm_mpc)
-  [Docker hub](https://hub.docker.com/r/jsadler2/swmm_mpc/)
-  [Demo model on HydroShare](https://www.hydroshare.org/resource/73b38d6417ac4352b9dae38a78a47d81/)

## Implementation notes
The following steps were taken to reproduce the analyses presented in Sadler, 2019 (the paper). Ultimately, I have not yet been able to reproduce the results using the Docker image. I have also been unable to reproduce the results using the installation instructions from the Git repo. Ultimately I determine this project to be inadequately documented and not reproducible without assistance from the author.

1. Local setup option
    1. Following the instructions on the [github repo](https://github.com/UVAdMIST/swmm_mpc) readme
        1. In anaconda prompt, create a new local environment `swmm_mpc_base` using python 2.7
        ```
        conda create -n swmm_mpc_base python=2.7
        ...
        conda activate swmm_mpc_base
        ```
        1. Install swmm_mpc from git
        ```
        pip install git+https://github.com/UVAdMIST/swmm_mpc
        ```
        1. This results in
        ```
        ERROR: gpy 1.10.0 has requirement scipy<1.5.0,>=1.3.0, but you'll have scipy 1.2.3 which is incompatible.
        ```
        And the build instructions call for GPy>=1.8, so this should perhaps be updated to `==1.8`, but this would require forking and re-stating the specs, so let's first test and see if it works out anyway...
        1. pip install copyreg - because of an error encountered later... does not work, no module found anywhere...

    1. Install SWMM 5.1 - I'm on my Windows machine so downloading the install program for 5.1.014 (closest available to the specified 5.1.012) on the [EPA SWMM downloads page](https://www.epa.gov/water-research/storm-water-management-model-swmm)
        1. Run the installer
        1. Get cybersecurity team to review SWMM - really?
    1. Install SWMM 5.2 - okay, well at least that works
        1. Add to path

-  Docker setup option
1. [Install Docker Desktop](https://docs.docker.com/desktop/)
1. If needed, review the basic concepts tutorials (very useful if they haven't been viewed previously)
1. From Docker Desktop, after creating an account in Docker Hub, find `jsadler2/swmm_mpc` and pull the container image
1. Select the image in Docker Desktop and Run - give the container name (optional), e.g., sadler_swmm_mpc
1. Examine the files in the container, note that:
    1. The `swmm5` contains the source code and build instructions for the SWMM5.1 engine
    1. In the `swmm5/Roadmap.txt` file (right-click and select edit to open and view), note that the engine can be compiled either as a DLL or as a standalone console app under both Windows and Linux, depending on which of the `#define DLL` and `#define CLE` declarations are commented out at the top of the `swmm5/src/swmm5.c` file
    1. Note, in that file, that the application is defined (ln 46) to build as a command-line executable (CLE) (recall that in C, the `//` character set indicates a comment)
    1. The `/swmm5/mk/gnu/Readme.txt` explains how to set things up to compile on Linux
    1. Comprehension question - is this system running Linux or Windows??
        1. I do not yet comprehend
    1. 
1. From Hydroshare, download zipped [demonstration model](https://www.hydroshare.org/resource/73b38d6417ac4352b9dae38a78a47d81/) archive to `C:\DTProjects\swmm_mpc` and extract
1. Following the instructions on the [github repo](https://github.com/UVAdMIST/swmm_mpc) readme
    1. 